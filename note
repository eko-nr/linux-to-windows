# Run to command VNC to allow RDP
reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
Set-Service -Name TermService -StartupType Automatic
Start-Service -Name TermService

#Verify RDP Service is Running
sc query TermService

#Disable Network Level Authentication (NLA) - For Compatibility
reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v UserAuthentication /t REG_DWORD /d 0 /f

#Configure Windows Firewall
netsh advfirewall firewall set rule group="remote desktop" new enable=Yes

#Check
netstat -an | find "3389"

# ============= RDP Connection Setup on Server ===========

# Get VM IP first
sudo virsh domifaddr win10ltsc

# Enable IP forwarding
sudo sysctl -w net.ipv4.ip_forward=1

# Forward port 3389 (replace VM_IP with actual IP)
sudo iptables -t nat -A PREROUTING -p tcp --dport 3389 -j DNAT --to-destination VM_IP:3389
sudo iptables -A FORWARD -p tcp -d VM_IP --dport 3389 -j ACCEPT
sudo iptables -t nat -A POSTROUTING -j MASQUERADE

# Save rules
sudo apt install iptables-persistent -y
sudo netfilter-persistent save

